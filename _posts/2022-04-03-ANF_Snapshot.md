---
title: Azure NetApp Filesのデータ保護機能（スナップショット編）
author: Yi Hu
date: 2022-04-03 00:00:00 +0900
categories: [Azure NetApp Files]
tags: [Azure NetApp Files, Backup, Snapshot]
---
ストレージの運用、管理において、どのようにデータを保護するのかは非常に重要な検討項目と考えられます。  

Azure NetApp Filesでは以下三つのデータ保護機能を提供しており、あらゆるのデータ保護の要件を満足できます。  

**１．スナップショット**  
**２．クロースリージョンレプリケーション（CRR）**  
**３．ANF バックアップ**  

データ保護機能の概要の比較は以下の表で整理しています。

<div style="text-align: left"><img src="/assets/blog/2022-04-03-ANF_Snapshot/1.png" ></div>
<br>

本記事はスナップショット機能の**概要、特徴、復元方法、利用シナリオ、コスト、注意事項**などの観点で機能を解説します。


# 概要
スナップショット機能は、NetAppのストレージテクノロジーを使ったブロックレベルの差分方式の Point in time バックアップ機能になります。

参考情報：[**スナップショットの概要**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/snapshots-introduction)  

# 特徴
１．ストレージサービスにおいてもスナップショット機能を有しているものは多く存在しますが、ANFのスナップショットは一瞬かつパフォーマンスに影響を与えることなく取得できます。

２．スナップショットを取得した場合、取得する時点でのメタデータをスナップショットとして保持し、そのメタデータがポイントするブロックを消去しないようにします。スナップショット取得後も本体ボリュームの挙動は変わらず、変更されたデータは新規ブロックに書き込まれ、メタデータの情報が更新されます。
この仕組みから、小さなメタデータの情報をコピーするだけなので一瞬で取得でき、実データをコピーするわけではないので容量も消費せず、本体ボリュームの挙動（読み取り、書き込み）は変わらないのでパフォーマンスに影響しません。

３．スナップショットは差分方式であり、フルバックアップではありません。（ANFバックアップはフルバックアップになります）

４．ANFではスナップショットポリシー機能が提供されており、ポリシーで事前に設定したスケジュールでサービス側がスナップショットを自動的に作成できます。また、世代管理もポリシーで行えます。サポートしているバックアップスケジュールは以下になります。  

・hourly  
・daily  
・weekly  
・monthly  
※複数のスケジュールを同時に設定することが可能です。例えば、ポリシーでhourly、dailyを同時に設定

参考情報：[**スナップショットポリシー**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/azure-netapp-files-manage-snapshots)  

５．スナップショットはRead onlyのため、ウイルス、マルウェアに感染することがありません。

# データ復元方法
１．ファイル単位の復元  
スナップショットを利用して、Azure Portalを利用せず、クライアントのOSから簡単にファイルを復元できます。
Windowsの場合は、操作のGUIはVSSと似ています。

参考情報：[**ファイル単位の復元**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/snapshots-restore-file-client)  

２．単一ファイル スナップショット復元  
１の方法でもファイル単位で復元できますが、復元時にファイル一回スナップショットからコピーする必要があり、ファイルサイズが大きい場合は、復元に時間がかかることがあります。
単一ファイル スナップショット復元機能（2021/12リリース）を利用すれば、スナップショットで保持したデータを利用して、置き換えの形でデータを復元するため、例えば、ファイルサイズが数十GBであっても、数秒ぐらいでデータを復元できます。操作はAzure Portalで実施します。

参考情報：[**単一ファイル スナップショット復元**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/snapshots-restore-file-single)  


３．ボリュームを元に戻す（Volume　Revert）  
スナップショットのRevert機能を利用することで、ほぼ瞬時にボリュームをスナップショット作成した時点の状態に戻せます。

参考情報：[**Volume Revert**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/snapshots-revert-volume)  

４．ボリューム複製  
スナップショットを利用して、ボリュームをほぼ瞬時に複製できます。

参考情報：[**Volume 複製**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/snapshots-restore-new-volume)  


# 利用シナリオ
１．想定外のデータ変更、削除操作を対処するため、定期的にスナップショットを取得します。

２．スナップショットがRead Onlyのため、ランサムウェア、ウイルス感染の事後対策として利用可能です。

３．単一ファイル スナップショット復元で数秒レベルで大きいファイルを復元できるので、AVD環境など大きいファイルのリストア操作が必要な環境でスナップショットを活用できます。

４．スナップショットを用いてほぼ瞬時にボリュームを複製できるので、DevOpsまたはSAPのような簡単に検証、開発環境を作成する需要があるワークロードでスナップを活用できます。

５．AzAcSnapというツール利用すれば、Oracle および SAP HANA データベースの整合性を取った状態のスナップショットを作成できます。

# 注意事項 
１．ボリュームごと最大255個のスナップショットを作成可能です。

２．ANF バックアップを有効したボリュームでは、Volume　Revert機能を利用できません。

３．CRR が設定されているDest、SourceボリュームはVolume　Revert機能を利用できません。

４．Volume　Revertでボリュームを元に戻しまたら、スナップショット作成後にボリュームに加えた変更、新規で作成したスナップショットが削除されます。

５．スナップショットはボリューム内で保管され、利用状況によってスナップショットがボリュームの容量を圧迫する可能性があります。ボリュームの空き容量がなくなったら、書き込みができなくなり、データベース壊れる恐れがあるので、ボリュームの空き容量の監視が必要です。

# コスト
スナップショットのデータは、スナップショット対象ボリュームの中に格納されます。つまり、スナップショットはボリュームの空き容量を消費する形になります。スナップショット自体が別途料金がかかりませんが、スナップショットを格納するためにより大きなボリュームを用意する必要があります。


**※リンク先などを含む本情報の内容は、作成日時点でのものであり、予告なく変更される場合がございますので、ご了承ください。**

[^ga-filters]: [Google Analytics Core Reporting API: Filters](https://developers.google.com/analytics/devguides/reporting/core/v3/reference#filters)