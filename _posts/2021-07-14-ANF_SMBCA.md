---
title: Azure NetApp Files SMB継続的可用性（SMB CA）機能 FAQ
author: Yi Hu
date: 2021-07-14 00:00:00 +0900
categories: [Azure NetApp Files]
tags: [Azure NetApp Files, NewFeature]
---
# 1. 概要
皆さんのご存知の通り、Azure NetApp Filesはマネージメントサービスであり、ストレージ側のシステム更新、セキュリティパッチの適用、それに物理ディスク、ノード障害時の自動フェールオーバーなどの通常ストレージ運用に不可欠なオペレーションは全部Azureデータセンターがカバーしていて、お客様側としてはメンテナンスフリーという形でサービスをご利用できます。  

ただ、サービス側で実施されるメンテナンス作業に伴って、OSのバージョンアップ、ノードの切り替えが実施されることがあり、それによって、ストレージに接続しているセッションが切られる可能性があります。  

このようなメンテナンスによるサービス影響を回避するため、SMB継続的可用性（SMB CA）が最近 Public Preivew しました。この機能を有効することにより、メンテナンスが実施されてもストレージへのセッションが維持され、接続瞬断によるサービス影響を避けることができます。そのため、この機能利用を強く推奨しています。 

この機能についてよく質問されていることについては本記事で整理してみました。  

# 2. SMB継続的可用性（SMB CA）機能 FAQ
1. ANFメンテナンスの影響範囲  
WVD/FsLogix+ANFをご利用する場合に、仮想デストップセッションの作成と同時に、WVDサーバー（つまり、FSLogix）は、仮想デスクトップに使用されているVHDXファイルのSMBセッション、ファイルハンドル、およびロックも確立されます。  
仮想デスクトップが再起動されるまで、仮想デスクトップのセッションが維持していてます。メンテナンスにて、ANFストレージアプライアンス切り替え、及び更新されたソフトウェアの再起動が発生される可能性がありますが、再起動にあたり、ユーザープロファイルが格納されているANFボリュームに対して、マウント用クライアント側でのセッションリセットがトリガーされます。  
FSLogixの場合に上記のセッションリセット実施の際に、同じファイルロック・ファイルハンドルが維持されることが予期されますので、FsLogixにてセッションリセットに対してのハンドルを自動回復することが叶いません。この場合、仮想デスクトップがハングされる可能性があります。  
SMB CA機能を有効化にすると、メンテナンス中にANFストレージアプライアンス切り替えが発生される際に、ファイルハンドルとロックデータも同時に移行されますので、FsLogixのようなアプリケーションがセッションリセットされても、継続的にユーザープロファイルへのファイルハンドル・ロックが利用可能となりますので、前述の仮想デスクトップのハングが回避できる状況となります。  
またSQLServerも同様に、メンテナンス中にSMB CA機能でファイルハンドルとロックデータが保存できますので、データベースクラッシュなどの悪影響が回避できるかと思います。

2. SMB 継続的可用性機能（SMB　CA機能）をどのように有効するのでしょうか  
WebFormにて有効化を申請できます。（[**SMB CA 申請フォーム**](https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR2Qj2eZL0mZPv1iKUrDGvc9UQUFTUjExUDA5VU5KMUY1RllSVjNEOUVTWCQlQCN0PWcu)）


3. SMB 継続的可用性機能（SMB　CA機能）を有効にすることで、追加で料金が発生するのでしょうか  
SMB 継続的可用性機能（SMB　CA機能）に対して追加料金が発生されないものと存じますが、SMB　CA機能有効化の実施作業にあたり容量プールのサイズが拡張必要となりましたら容量プールのサイズに相応的な追加料金が発生される可能性があります。

4. SMB 継続的可用性機能（SMB　CA機能）をサポートしているワークロードは何でしょうか  
現状以下のワークロードのみがサポートしています。  
・Microsoft SQL Database  
・Fslogix  

5. CA機能有効化を推奨ということですが、他用途で有効化するとアプリがうまく動作しないなどがあるのでしょうか  
他用途でご利用頂いているANFボリュームに対して、前述の通りでセッションリセットが実施されても、継続的にファイルハンドルの利用が必要ない場合には、SMB CA機能の有効化の実施は必要がありません。仮にCA機能を有効化にしても特に悪影響が発生ないものと思います。

6. CA機能とリージョン間レプリケーション機能の併用は問題ない認識でよろしいでしょうか  
CA機能とリージョン間レプリケーション機能の併用は問題がありません。

7. 既存のボリュームをこの機能を有効することできますでしょうか  
操作方法は公式ドキュメントにて公開されています。（[**既存の SMB ボリュームを変換して継続的可用性を使用する**](https://docs.microsoft.com/ja-jp/azure/azure-netapp-files/enable-continuous-availability-existing-smb)）


**※リンク先などを含む本情報の内容は、作成日時点でのものであり、予告なく変更される場合がございますので、ご了承ください。**

[^ga-filters]: [Google Analytics Core Reporting API: Filters](https://developers.google.com/analytics/devguides/reporting/core/v3/reference#filters)